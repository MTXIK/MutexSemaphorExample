#include <stdio.h>
#include <stdlib.h>
#include <pthread.h>
#include <unistd.h>
#include <string.h>

// Структура, представляющая бабуина
typedef struct {
    int id;           // Уникальный идентификатор бабуина
    char direction;   // Направление движения: 'W' (Запад) или 'E' (Восток)
} baboon_t;

// Инициализация мьютекса и условных переменных
pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER;       // Мьютекс для защиты критической секции
pthread_cond_t cond_west = PTHREAD_COND_INITIALIZER;      // Условная переменная для бабуинов, движущихся на запад
pthread_cond_t cond_east = PTHREAD_COND_INITIALIZER;      // Условная переменная для бабуинов, движущихся на восток

// Глобальные переменные для текущего направления и количества бабуинов в критической секции
char current_direction = 'N'; // 'N' - нет направления, 'W' - запад, 'E' - восток
int count = 0;                 // Количество бабуинов в критической секции

// Функция, выполняемая каждым потоком-бабуином
void* baboon_thread(void* arg) {
    baboon_t *baboon = (baboon_t*)arg; // Преобразование аргумента к типу baboon_t*
    char dir = baboon->direction;      // Направление движения бабуина
    int id = baboon->id;               // Идентификатор бабуина

    // Вывод сообщения о попытке войти в критическую секцию
    printf("Бабуин %d пытается зайти в критическую секцию (%s).\n", id, dir == 'W' ? "Запад" : "Восток");

    // Блокируем мьютекс перед доступом к общим ресурсам
    pthread_mutex_lock(&mutex);

    // Ожидание, пока направление не станет 'N' (нет направления) или совпадет с направлением текущего бабуина
    while (current_direction != 'N' && current_direction != dir) {
        if (dir == 'W') {
            // Если направление запад, ждем на условной переменной cond_west
            pthread_cond_wait(&cond_west, &mutex);
        } else {
            // Если направление восток, ждем на условной переменной cond_east
            pthread_cond_wait(&cond_east, &mutex);
        }
    }

    // Если текущего направления нет, устанавливаем его в направлении текущего бабуина
    if (current_direction == 'N') {
        current_direction = dir;
    }

    // Увеличиваем количество бабуинов в критической секции
    count++;
    printf("Бабуин %d зашел в критическую секцию (%s). Текущее количество: %d\n", id, dir == 'W' ? "Запад" : "Восток", count);

    // Разблокируем мьютекс после изменения общих ресурсов
    pthread_mutex_unlock(&mutex);

    // Симуляция работы в критической секции (задержка 1 секунда)
    sleep(1);

    // Вход в выход из критической секции
    pthread_mutex_lock(&mutex); // Блокируем мьютекс для доступа к общим ресурсам
    count--;                    // Уменьшаем количество бабуинов в критической секции
    printf("Бабуин %d вышел из критической секции (%s). Текущее количество: %d\n", id, dir == 'W' ? "Запад" : "Восток", count);

    // Если больше нет бабуинов в критической секции, сбрасываем направление и сигнализируем ожидающим потокам противоположного направления
    if (count == 0) {
        current_direction = 'N'; // Сбрасываем текущее направление

        // Сигнализируем всем ожидающим потокам противоположного направления
        if (dir == 'W') {
            pthread_cond_broadcast(&cond_east); // Разбудить все потоки, ожидающие на cond_east
        } else {
            pthread_cond_broadcast(&cond_west); // Разбудить все потоки, ожидающие на cond_west
        }
    }

    pthread_mutex_unlock(&mutex); // Разблокируем мьютекс после изменения общих ресурсов

    free(baboon); // Освобождаем память, выделенную для структуры baboon_t
    return NULL;   // Завершаем поток
}

int main() {
    pthread_t threads[10]; // Массив идентификаторов потоков

    // Создание 10 потоков-бабуинов с разными направлениями
    for (int i = 0; i < 10; i++) {
        baboon_t *baboon = malloc(sizeof(baboon_t)); // Выделение памяти для структуры baboon_t
        if (baboon == NULL) {                        // Проверка успешности выделения памяти
            perror("Не удалось выделить память для бабуина");
            exit(EXIT_FAILURE);
        }
        baboon->id = i + 1;                          // Установка идентификатора бабуина
        baboon->direction = (i % 2 == 0) ? 'W' : 'E';// Установка направления: четные - 'W', нечетные - 'E'

        // Создание потока-бабуина
        if (pthread_create(&threads[i], NULL, baboon_thread, baboon) != 0) {
            perror("Не удалось создать поток");
            free(baboon); // Освобождаем память в случае ошибки
            exit(EXIT_FAILURE);
        }

        usleep(100000); // Задержка 100 миллисекунд для разнообразия порядка входа
    }

    // Ожидание завершения всех потоков
    for (int i = 0; i < 10; i++) {
        pthread_join(threads[i], NULL);
    }

    // Разрушение мьютекса и условных переменных после завершения работы
    pthread_mutex_destroy(&mutex);
    pthread_cond_destroy(&cond_west);
    pthread_cond_destroy(&cond_east);

    return 0; // Завершение программы
}
